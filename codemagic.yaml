workflows:
  build_dia_register_release:
    name: Build DIA Register (APK + AAB)
    max_build_duration: 60
    environment:
      flutter: stable
      vars:
        ZIP_FILE: "dia_register_fixed.zip"
        UNZIP_DIR: "unzipped_project"

    scripts:
      # 1ï¸âƒ£ Unzip the uploaded Flutter project
      - name: Extract project
        script: |
          echo "ğŸ“¦ Extracting Flutter project..."
          rm -rf $UNZIP_DIR
          mkdir -p $UNZIP_DIR
          unzip -q "$ZIP_FILE" -d "$UNZIP_DIR"
          echo "âœ… Extraction complete. Folder structure:"
          ls -R $UNZIP_DIR

      # 2ï¸âƒ£ Auto-detect folder containing pubspec.yaml
      - name: Locate Flutter project folder
        script: |
          echo "ğŸ” Searching for pubspec.yaml..."
          export PROJECT_DIR=$(find $UNZIP_DIR -type f -name "pubspec.yaml" -exec dirname {} \; | head -n 1)
          if [ -z "$PROJECT_DIR" ]; then
            echo "âŒ No Flutter project found!"; exit 1
          fi
          echo "âœ… Found Flutter project at: $PROJECT_DIR"
          echo "PROJECT_DIR=$PROJECT_DIR" >> $CM_ENV_PATH

      # 3ï¸âƒ£ Install dependencies
      - name: Install Flutter dependencies
        script: |
          echo "ğŸš€ Running flutter pub get..."
          cd "$PROJECT_DIR"
          flutter pub get
          echo "âœ… Dependencies installed."

      # 4ï¸âƒ£ Build release APKs
      - name: Build Android APKs (optimized)
        script: |
          cd "$PROJECT_DIR"
          echo "ğŸ—ï¸ Building release APK..."
          flutter build apk --release \
            --split-per-abi \
            --obfuscate \
            --split-debug-info=build/debug_info
          echo "âœ… APK build complete."

      # 5ï¸âƒ£ Build release AAB
      - name: Build Android App Bundle (AAB)
        script: |
          cd "$PROJECT_DIR"
          echo "ğŸ—ï¸ Building release AAB..."
          flutter build appbundle --release \
            --obfuscate \
            --split-debug-info=build/debug_info
          echo "âœ… AAB build complete."

      # 6ï¸âƒ£ Collect build outputs
      - name: Move artifacts
        script: |
          echo "ğŸ“¦ Collecting all build outputs..."
          mkdir -p build_outputs
          cp $PROJECT_DIR/build/app/outputs/flutter-apk/*.apk build_outputs/ || true
          cp $PROJECT_DIR/build/app/outputs/bundle/release/*.aab build_outputs/ || true
          echo "âœ… All artifacts moved to build_outputs folder."

    artifacts:
      - build_outputs/*.apk
      - build_outputs/*.aab

    publishing:
      email:
        recipients:
          - your@email.com

